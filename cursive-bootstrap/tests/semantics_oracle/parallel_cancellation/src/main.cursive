# SPEC_COV: Parallel-Cancellation
# SPEC_COV: ยง18.6.1-CancelToken
# SPEC_COV: ยง18.6.2-Cancellation
// Tests cooperative cancellation with CancelToken.

public procedure main(ctx: Context) -> i32 {
  let domain = ctx~>cpu()
  let token: CancelToken@Active = CancelToken::new()

  parallel domain [cancel: token] {
    let _ = wait spawn {
      // Request cancellation
      token~>cancel()
    }

    // Check if cancelled
    let is_cancelled: bool = token~>is_cancelled()
    if is_cancelled {
      let msg = "cancelled"
      let _ = match ctx.fs~>write_stdout(msg) {
        ok: () => ()
        err: IoError => ()
      }
    }
  }

  return 0i32
}
