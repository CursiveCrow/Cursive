# SPEC_COV: Match-Modal-State
# SPEC_COV: Modal-Widen
# SPEC_COV: Modal-Transition
# Tests modal transitions, widening, and matching.
modal Connection {
  @Closed {
    count: i32
    transition connect() -> @Connected {
      return Connection@Connected { id: 42 };
    }
  }
  @Connected { id: i32 }
}

public procedure main(ctx: Context) -> i32 {
  let closed_u: unique Connection@Closed = unsafe {
    transmute::<Connection@Closed, unique Connection@Closed>(Connection@Closed { count: 0 })
  };
  let connected: Connection@Connected = (move closed_u)~>connect();
  let state: Connection = widen (move connected);
  let out: i32 = match move state {
    @Closed { count } => count,
    @Connected { id } => id
  };
  let msg: string@View = if out == 42i32 { "ok" } else { "bad" };
  let _ = match ctx.fs~>write_stdout(msg) {
    ok: () => (),
    err: IoError => ()
  };
  return 0i32;
}
