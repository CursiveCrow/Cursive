// RUN: run-pass
// EXIT: 42
// SPEC: 6.4 Lower-Expr-Propagate
// DESC: Verify union propagation (?) operator lowering

procedure may_succeed() -> i32 | () {
    return 42
}

procedure may_fail() -> i32 | () {
    return ()
}

procedure caller_success() -> i32 | () {
    let v: i32 = may_succeed()?
    return v
}

procedure caller_fail() -> i32 | () {
    let v: i32 = may_fail()?
    return v + 1
}

public procedure main(move ctx: Context) -> i32 {
    let r1: i32 | () = caller_success()
    let r2: i32 | () = caller_fail()

    let v1: i32 = match r1 {
        v: i32 => { v }
        _: () => { 0 }
    }

    let v2: i32 = match r2 {
        v: i32 => { v }
        _: () => { 0 }
    }

    return if v2 == 0 { v1 } else { 1 }
}
