# SPEC_COV: C0X-Wait-Key-Restriction
# SPEC_COV: E-CON-0160
// Tests that wait is invalid when keys are held (ยง10.3)
// Expected diagnostic: E-CON-0160

record Data { value: i32 }

public procedure main(ctx: Context) -> i32 {
  let domain = ctx~>cpu()
  var d: shared Data = Data { value: 42 }
  let res: i32 = parallel domain {
    let h = spawn {
      return 42
    }
    # d read {
      // Error: keys held across wait suspension point
      return wait h
    }
  }
  return res
}
