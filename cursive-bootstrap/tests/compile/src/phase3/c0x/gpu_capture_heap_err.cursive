# SPEC_COV: C0X-GPU-Capture-Heap
# SPEC_COV: E-CON-0152
// Tests heap-provenanced value capture in GPU domain is error (ยง18.2.2)
// Expected diagnostic: E-CON-0152

public procedure main(ctx: Context) -> i32 {
  let domain: $GpuDomain = ctx~>gpu()
  // Heap-allocated string
  let heap_str: string@Managed = match cursive::runtime::string::from("hello", ctx.heap) {
    ok: string@Managed => ok
    err: AllocationError => return 1i32
  }
  parallel domain {
    // Error: heap-provenanced value captured in GPU domain
    dispatch i in 0..100 {
      let len: usize = heap_str~>length()
    }
  }
  return 0
}
